<!doctype html>
<html lang="bg">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>МБАЛ „Рахила Ангелова“ – гр. Перник</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div class="app-shell">
      <header class="site-header">
        <div class="header-inner">
          <div class="brand">
            <div class="brand-text">
              <h1>
                <a href="{{ url_for('index') }}">МБАЛ „Рахила Ангелова“ – гр. Перник</a>
              </h1>
            </div>
          </div>
        </div>
      </header>

      <section class="toolbar">
        <div class="page-navigation">
          {% if not is_main_page %}
          <button
            onclick="location.href='{{ url_for('index') }}'"
            class="page-btn"
          >
            Начало
          </button>
          {% endif %}
          {% for page in pages %}
          <button
            onclick="location.href='{{ url_for('index', page=page.id) }}'"
            class="page-btn {% if page.id == current_page %}active{% endif %}"
          >
            {{ page.name }}
          </button>
          {% endfor %}
        </div>
        <div class="toolbar-side">
          <div class="search-container">
            <label class="search-label" for="search-input">Търсене</label>
            <div class="search-field">
              <input
                type="text"
                id="search-input"
                placeholder="Търси в тази страница..."
                oninput="searchEntries(this.value)"
              />
            </div>
          </div>
          <div class="terms-container">
            <span class="terms-label">Общи условия</span>
            <a
              href="{{ url_for('pdf_viewer', filename='обществени-поръчки.pdf') }}"
              class="pdf-link"
              style="text-decoration: underline;"
             target="_blank" rel="noopener">
              ВЪТРЕШНИ ПРАВИЛА ЗА ВЪЗЛАГАНЕ НА ОБЩЕСТВЕНИ ПОРЪЧКИ - актуализирано на 16.06.2015
            </a>
          </div>
        </div>
      </section>

      <main class="content">
        {% if is_main_page %}
        <div class="profile-container" id="profile-container">
          <div class="panel static-profile">
            <div class="panel-heading">
              <h3 class="panel-title">{{ profile.title }}</h3>
            </div>
            <div class="panel-body profile-body" data-collapsible="false">
              <div class="panel-content profile-content">
                {% if profile_logo_url %}
                <div class="profile-logo">
                  <img src="{{ profile_logo_url }}" alt="Лого на МБАЛ „Рахила Ангелова“" />
                </div>
                {% endif %}
                {% for paragraph in profile.body.split('\n\n') %}
                  {% set trimmed = paragraph.strip() %}
                  {% if trimmed in ['УПРАВЛЕНИЕ:', 'АДРЕС:', 'ЕЛЕКТРОННА ПОЩА:'] %}
                    <p class="profile-section">{{ trimmed }}</p>
                  {% else %}
                    <p>{{ paragraph | e }}</p>
                  {% endif %}
                {% endfor %}
                {% if profile.files %}
                <div class="files-section profile-files">
                  <h4>Файлове</h4>
                  <ul class="files">
                    {% for file in profile.files %}
                    <li>
                      <a href="{{ file.url }}" target="_blank" rel="noopener">{{ file.name or file.filename }}</a>
                    </li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if not is_main_page %}
        <div class="panels-container entries-container">
          {% if entries %} {% for entry in entries %}
          <div class="panel">
            <div class="panel-heading collapsed" onclick="togglePanel({{ entry.id }})">
              {% set display_title = entry.title or entry.heading %}
              <h3 class="panel-title">{{ display_title }}</h3>
              <span class="toggle-icon" aria-hidden="true">▾</span>
            </div>
            <div class="panel-body collapsed" data-collapsible="true" id="panel-body-{{ entry.id }}">
              <div class="panel-content">
                <div class="panel-meta">
                  {% if entry.publish_date %}
                  <div class="meta-row"><strong>Дата на публикуване:</strong> {{ entry.publish_date }}</div>
                  {% endif %}
                  {% if entry.aop_number %}
                  <div class="meta-row"><strong>Номер от АОП:</strong> {{ entry.aop_number }}</div>
                  {% endif %}
                  {% if entry.internal_number %}
                  <div class="meta-row"><strong>Вътрешен номер:</strong> {{ entry.internal_number }}</div>
                  {% endif %}
                </div>

                {% if entry.content %}
                <pre class="entry-content">{{ entry.content }}</pre>
                {% endif %}

                {% set structured_files = entry.files if entry.files is defined else [] %}
                {% set pdf_files = entry.pdf_files if entry.pdf_files is defined else ([] if not entry.pdf_file else [{'name': entry.pdf_file, 'url': '/pdf/' ~ entry.pdf_file}]) %}
                {% set ns = namespace(pdf_map={}) %}
                {% for pf in pdf_files %}
                  {% if pf.name or pf.url %}
                    {% set _ = ns.pdf_map.update({(pf.name or pf.url): pf.url}) %}
                  {% endif %}
                {% endfor %}
                <div class="files-section">
                  <h4>Файлове</h4>
                  {% if structured_files and structured_files|length > 0 %}
                  <ul class="files">
                    {% for file in structured_files %}
                    <li>
                      {% set display_name = file.name or file.url %}
                      {% set link_url = ns.pdf_map.get(display_name) %}
                      {% if link_url %}
                        <a href="{{ link_url }}" target="_blank" rel="noopener">{{ display_name }}</a>
                      {% else %}
                        {{ display_name }}
                      {% endif %}
                      {% if file.published_at %}
                        <span class="file-meta"> — Публикувано на: {{ file.published_at }}</span>
                      {% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                  {% elif pdf_files %}
                  <ul class="files">
                    {% for pdf_name in pdf_files %}
                    <li>
                      <a
                        href="{{ pdf_name.url }}"
                        target="_blank" rel="noopener"
                      >
                        {{ pdf_name.name or pdf_name.url }}
                      </a>
                    </li>
                    {% endfor %}
                  </ul>
                  {% else %}
                  <p class="no-files">Няма прикачени файлове.</p>
                  {% endif %}
                </div>

                <small class="entry-date">Публикувано: {{ entry.date }}</small>
              </div>
            </div>
          </div>
          {% endfor %} {% endif %}
        </div>
        {% endif %}
      </main>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  </body>
</html>
